<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆPDFç”Ÿæˆï¼ˆåˆç‰ˆï¼‰</title>
    <style>
        body {
            font-family: 'Noto Sans JP', 'Yu Gothic', 'Meiryo', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .control-panel {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-panel h2 {
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .input-group textarea {
            min-height: 80px;
            font-family: inherit;
        }

        .checkbox-group {
            margin-bottom: 15px;
        }

        .checkbox-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .checkbox-item .notes {
            margin-top: 5px;
            padding: 8px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #545b62;
        }

        #report-preview {
            background-color: white;
            padding: 40px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        #report-preview h1 {
            border-bottom: 3px solid #333;
            padding-bottom: 10px;
        }

        #report-preview h2 {
            margin-top: 30px;
            color: #333;
            border-left: 4px solid #007bff;
            padding-left: 10px;
        }

        #report-preview h3 {
            margin-top: 20px;
            color: #555;
        }

        .footnotes {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
        }

        .footnote-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f9f9f9;
            border-left: 3px solid #007bff;
        }

        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .control-panel {
                display: none !important;
            }
            #report-preview {
                box-shadow: none;
                padding: 20px;
                display: block !important;
            }
        }

        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instructions h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h2>ğŸ“„ èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆPDFç”Ÿæˆï¼ˆåˆç‰ˆï¼‰</h2>
        
        <div class="instructions">
            <h3>ä½¿ã„æ–¹</h3>
            <ol>
                <li>å„é …ç›®ã«èª¿æŸ»çµæœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                <li>è„šæ³¨ã¨ã—ã¦å«ã‚ãŸã„ãƒã‚§ãƒƒã‚¯é …ç›®ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„</li>
                <li>ã€Œãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º</li>
                <li>ã€ŒPDFå‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã§PDFå½¢å¼ã§ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰</li>
            </ol>
        </div>

        <div class="input-group">
            <label for="propertyTitle">ç‰©ä»¶æ¦‚è¦:</label>
            <input type="text" id="propertyTitle" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒºxxx x-x-xï¼ˆâ—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³ï¼‰" value="æ±äº¬éƒ½æ¸‹è°·åŒºæµæ¯”å¯¿1-2-3ï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒãƒ³ã‚·ãƒ§ãƒ³ï¼‰">
        </div>

        <div class="input-group">
            <label for="urbanPlanning">éƒ½å¸‚è¨ˆç”»:</label>
            <textarea id="urbanPlanning" placeholder="ç”¨é€”åœ°åŸŸã€é˜²ç«åœ°åŸŸãªã©ã®æƒ…å ±ã‚’å…¥åŠ›">ç”¨é€”åœ°åŸŸ: ç¬¬ä¸€ç¨®ä½å±…åœ°åŸŸ
é˜²ç«åœ°åŸŸ: æº–é˜²ç«åœ°åŸŸ
é«˜åº¦åœ°åŒº: ç¬¬äºŒç¨®é«˜åº¦åœ°åŒº</textarea>
        </div>

        <div class="input-group">
            <label for="road">é“è·¯:</label>
            <textarea id="road" placeholder="æ¥é“çŠ¶æ³ã€é“è·¯ç¨®åˆ¥ãªã©ã®æƒ…å ±ã‚’å…¥åŠ›">æ¥é“: å¹…å“¡6m å…¬é“ï¼ˆå»ºç¯‰åŸºæº–æ³•42æ¡1é …1å·ï¼‰
ã‚»ãƒƒãƒˆãƒãƒƒã‚¯: ä¸è¦</textarea>
        </div>

        <div class="input-group">
            <label for="infrastructure">ã‚¤ãƒ³ãƒ•ãƒ©:</label>
            <textarea id="infrastructure" placeholder="ä¸Šä¸‹æ°´é“ã€ã‚¬ã‚¹ãªã©ã®æƒ…å ±ã‚’å…¥åŠ›">ä¸Šæ°´é“: Ï†200mmé…ç®¡æ¸ˆã¿
ä¸‹æ°´é“: æœ¬ä¸‹æ°´æ¥ç¶šæ¸ˆã¿
ã‚¬ã‚¹: éƒ½å¸‚ã‚¬ã‚¹ä¾›çµ¦åŒºåŸŸ</textarea>
        </div>

        <div class="input-group">
            <label for="hazard">é˜²ç½:</label>
            <textarea id="hazard" placeholder="ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã€æ´ªæ°´ãƒªã‚¹ã‚¯ãªã©ã®æƒ…å ±ã‚’å…¥åŠ›">æ´ªæ°´ãƒã‚¶ãƒ¼ãƒ‰: æµ¸æ°´æƒ³å®šåŒºåŸŸå¤–
åœŸç ‚ç½å®³: è­¦æˆ’åŒºåŸŸå¤–
æ¶²çŠ¶åŒ–ãƒªã‚¹ã‚¯: ä½</textarea>
        </div>

        <div class="input-group">
            <label for="remarks">å‚™è€ƒ:</label>
            <textarea id="remarks" placeholder="ãã®ä»–ç‰¹è¨˜äº‹é …">ç‰¹ã«ãªã—</textarea>
        </div>

        <h3>ãƒã‚§ãƒƒã‚¯æ¸ˆã¿é …ç›®ï¼ˆè„šæ³¨ç”¨ï¼‰</h3>
        <div class="checkbox-group" id="checklistItems">
            <div class="checkbox-item">
                <input type="checkbox" id="item1" data-notes='{"sourceUrl":"https://www.city.shibuya.tokyo.jp/urban_planning","checkedAt":"2025-01-15","by":"å±±ç”°å¤ªéƒ"}' checked>
                <label for="item1">ç”¨é€”åœ°åŸŸç¢ºèª</label>
                <div class="notes">å‡ºå…¸: https://www.city.shibuya.tokyo.jp/urban_planning | å–å¾—æ—¥: 2025-01-15 | æ‹…å½“: å±±ç”°å¤ªéƒ</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="item2" data-notes='{"sourceUrl":"https://www.city.shibuya.tokyo.jp/fire_area","checkedAt":"2025-01-15","by":"å±±ç”°å¤ªéƒ"}' checked>
                <label for="item2">é˜²ç«åœ°åŸŸç¢ºèª</label>
                <div class="notes">å‡ºå…¸: https://www.city.shibuya.tokyo.jp/fire_area | å–å¾—æ—¥: 2025-01-15 | æ‹…å½“: å±±ç”°å¤ªéƒ</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="item3" data-notes='{"sourceUrl":"https://www.city.shibuya.tokyo.jp/road_registry","checkedAt":"2025-01-16","by":"ä½è—¤èŠ±å­"}' checked>
                <label for="item3">é“è·¯å°å¸³ç¢ºèª</label>
                <div class="notes">å‡ºå…¸: https://www.city.shibuya.tokyo.jp/road_registry | å–å¾—æ—¥: 2025-01-16 | æ‹…å½“: ä½è—¤èŠ±å­</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="item4" data-notes='{"sourceUrl":"https://www.city.shibuya.tokyo.jp/water_supply","checkedAt":"2025-01-16","by":"ä½è—¤èŠ±å­"}' checked>
                <label for="item4">ä¸Šä¸‹æ°´é“å°å¸³ç¢ºèª</label>
                <div class="notes">å‡ºå…¸: https://www.city.shibuya.tokyo.jp/water_supply | å–å¾—æ—¥: 2025-01-16 | æ‹…å½“: ä½è—¤èŠ±å­</div>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="item5" data-notes='{"sourceUrl":"https://www.city.shibuya.tokyo.jp/hazard_map","checkedAt":"2025-01-17","by":"éˆ´æœ¨ä¸€éƒ"}' checked>
                <label for="item5">ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ç¢ºèª</label>
                <div class="notes">å‡ºå…¸: https://www.city.shibuya.tokyo.jp/hazard_map | å–å¾—æ—¥: 2025-01-17 | æ‹…å½“: éˆ´æœ¨ä¸€éƒ</div>
            </div>
        </div>

        <button onclick="generateReport()">ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
        <button onclick="printToPDF()" class="secondary">ğŸ“¥ PDFå‡ºåŠ›</button>
    </div>

    <div id="report-preview">
        <!-- Report content will be generated here -->
    </div>

    <script>
        // Load template
        async function loadTemplate() {
            try {
                const response = await fetch('../Templates/å ±å‘Šæ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.md');
                const template = await response.text();
                return template;
            } catch (error) {
                console.error('Template load error:', error);
                // Fallback template
                return `# èª¿æŸ»å ±å‘Šæ›¸

## ç‰©ä»¶æ¦‚è¦
{propertyTitle}

## éƒ½å¸‚è¨ˆç”»
{sections.éƒ½å¸‚è¨ˆç”»}

## é“è·¯
{sections.é“è·¯}

## ã‚¤ãƒ³ãƒ•ãƒ©
{sections.ã‚¤ãƒ³ãƒ•ãƒ©}

## é˜²ç½
{sections.é˜²ç½}

## å‚™è€ƒ
{sections.å‚™è€ƒ}

## å‡ºå…¸ãƒ»å‚è€ƒæƒ…å ±
{footnotes}`;
            }
        }

        // Collect footnotes from checked items
        function collectFootnotes() {
            const footnotes = [];
            const checkboxes = document.querySelectorAll('#checklistItems input[type="checkbox"]:checked');
            
            checkboxes.forEach(checkbox => {
                const notesData = checkbox.getAttribute('data-notes');
                if (notesData) {
                    try {
                        const notes = JSON.parse(notesData);
                        if (notes.sourceUrl && notes.checkedAt && notes.by) {
                            footnotes.push({
                                sourceUrl: notes.sourceUrl,
                                checkedAt: notes.checkedAt,
                                by: notes.by,
                                label: checkbox.nextElementSibling.textContent
                            });
                        }
                    } catch (e) {
                        console.error('Failed to parse notes:', e);
                    }
                }
            });
            
            return footnotes;
        }

        // Format footnotes as HTML
        function formatFootnotes(footnotes) {
            if (footnotes.length === 0) {
                return '<p>è„šæ³¨ãªã—</p>';
            }
            
            let html = '<div class="footnotes">';
            footnotes.forEach((footnote, index) => {
                html += `
                    <div class="footnote-item">
                        <strong>[${index + 1}] ${footnote.label}</strong><br>
                        å‡ºå…¸: ${footnote.sourceUrl}<br>
                        å–å¾—æ—¥: ${footnote.checkedAt}<br>
                        æ‹…å½“: ${footnote.by}
                    </div>
                `;
            });
            html += '</div>';
            
            return html;
        }

        // Convert markdown headings to HTML
        function markdownToHtml(markdown) {
            return markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/\n/g, '<br>');
        }

        // Generate report preview
        async function generateReport() {
            // Get input values
            const propertyTitle = document.getElementById('propertyTitle').value || 'ï¼ˆç‰©ä»¶æƒ…å ±æœªå…¥åŠ›ï¼‰';
            const sections = {
                'éƒ½å¸‚è¨ˆç”»': document.getElementById('urbanPlanning').value || 'ï¼ˆæœªå…¥åŠ›ï¼‰',
                'é“è·¯': document.getElementById('road').value || 'ï¼ˆæœªå…¥åŠ›ï¼‰',
                'ã‚¤ãƒ³ãƒ•ãƒ©': document.getElementById('infrastructure').value || 'ï¼ˆæœªå…¥åŠ›ï¼‰',
                'é˜²ç½': document.getElementById('hazard').value || 'ï¼ˆæœªå…¥åŠ›ï¼‰',
                'å‚™è€ƒ': document.getElementById('remarks').value || 'ï¼ˆãªã—ï¼‰'
            };
            
            // Collect footnotes
            const footnotes = collectFootnotes();
            const footnotesHtml = formatFootnotes(footnotes);
            
            // Load template
            const template = await loadTemplate();
            
            // Replace variables in template
            let report = template
                .replace('{propertyTitle}', propertyTitle)
                .replace('{sections.éƒ½å¸‚è¨ˆç”»}', sections['éƒ½å¸‚è¨ˆç”»'])
                .replace('{sections.é“è·¯}', sections['é“è·¯'])
                .replace('{sections.ã‚¤ãƒ³ãƒ•ãƒ©}', sections['ã‚¤ãƒ³ãƒ•ãƒ©'])
                .replace('{sections.é˜²ç½}', sections['é˜²ç½'])
                .replace('{sections.å‚™è€ƒ}', sections['å‚™è€ƒ'])
                .replace('{footnotes}', footnotesHtml);
            
            // Convert markdown to HTML
            const reportHtml = markdownToHtml(report);
            
            // Display preview
            const previewDiv = document.getElementById('report-preview');
            previewDiv.innerHTML = reportHtml;
            previewDiv.style.display = 'block';
            
            // Scroll to preview
            previewDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Print to PDF using browser's print dialog
        function printToPDF() {
            const previewDiv = document.getElementById('report-preview');
            if (previewDiv.style.display === 'none') {
                alert('ã¾ãšãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // Trigger browser print dialog
            window.print();
        }

        // Auto-generate report on page load
        window.addEventListener('load', () => {
            generateReport();
        });
    </script>
</body>
</html>
